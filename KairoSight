#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys, os
from pathlib import PurePath
from skimage import io
import numpy as np
from PyQt5 import QtCore
from PyQt5.QtCore import QDir, QModelIndex
from PyQt5.QtWidgets import QApplication, QWidget, QMainWindow, QMdiSubWindow, QFileDialog, QFileSystemModel,\
    QTreeView, QTextEdit
from KairoSightMainMDI import Ui_MDIMainWindow
from KairoSightWidgetTIFF import Ui_WidgetTiff
from KairoSightWidgetFolderTree import Ui_WidgetFolderTree


class DesignerMainWindow(QMainWindow, Ui_MDIMainWindow):
    """Customization for Qt Designer created window"""

    def __init__(self, parent=None):
        # initialization of the superclass
        super(DesignerMainWindow, self).__init__(parent)
        # setup the GUI --> function generated by pyuic4
        self.setupUi(self)
        # connect the signals with the slots
        # self.actionLoad.triggered.connect(self.open_tiff)
        # self.actionClose.triggered.connect(self.close)
        self.actionTIFF.triggered.connect(self.open_tiff)
        self.actionFolder.triggered.connect(self.open_folder)

    def open_tiff(self, file=None):
        """Open a SubWindow with a TIFF stack in the main MDI area"""
        if file is None:
            # Use a QFileDialog to get filepath if none provided
            filepath, mask = QFileDialog.getOpenFileName(self, 'Open a .tif/.tiff stack')
        else:
            filepath = file
            print('Opening tiff with passed filepath: ' + file)

        print('Path chosen: ' + filepath)
        if filepath:
            f = PurePath(filepath)
            f_name = f.stem
            f_ext = f.suffix
            print('file (name ext): ' + f_name + ' ' + f_ext)
            if f_ext is '.tif' or '.tiff':
                print('TIFF chosen')
                # Create QMdiSubWindow with Ui_WidgetTiff
                sub = DesignerSubWindowTiff(filepath=filepath)
                print('DesignerSubWindowTiff "sub" created')
                print('Set "sub" widget to "Ui_WidgetTiff"')
                sub.setWindowTitle("TIFF View: " + filepath)
                # Add and connect QMdiSubWindow to MDI
                self.mdiArea.addSubWindow(sub)
                print('"sub" added to MDI')
                sub.show()

    def open_folder(self):
        """Open a SubWindow with a folder tree view in the main MDI area"""
        folder_path = QFileDialog.getExistingDirectory(self, 'Choose a folder to view')
        print('Folder chosen! path: ' + folder_path)
        # Create QMdiSubWindow with Ui_WidgetTiff
        sub = DesignerSubWindowFolder(root=folder_path)
        print('DesignerSubWindowFolder "sub" created')
        print('Set "sub" widget to "Ui_WidgetFolderTree"')
        sub.setWindowTitle('Folder View: ' + folder_path)
        # Add and connect QMdiSubWindow to MDI
        self.mdiArea.addSubWindow(sub)
        sub.pushButtonOpen.released.connect(lambda: self.open_tiff(sub.currentFilePath))
        print('"sub" added to MDI')
        sub.show()


class DesignerSubWindowTiff(QWidget, Ui_WidgetTiff):
    """Customization for WidgetTiff subwindow for an MDI"""
    def __init__(self, parent=None, filepath=None):
        # initialization of the superclass
        super(DesignerSubWindowTiff, self).__init__(parent)
        # setup the GUI --> function generated by pyuic4
        self.setupUi(self)
        self.horizontalScrollBar.valueChanged['int'].connect(self.update_video)

        # Using skimage aka scikit-image from SciPy
        self.filepath = filepath
        file_path = PurePath(filepath)
        self.video_name = file_path.stem
        self.video_ext = file_path.suffix
        self.video_file = io.imread(filepath)
        self.video_shape = self.video_file.shape
        self.num_frames = self.video_file.shape[0]
        print('video shape: ', self.video_shape)
        print('Width x Height: ', self.video_file.shape[1], self.video_file.shape[2])
        print('# of Frames: ', self.num_frames)
        self.horizontalScrollBar.setMinimum(1)
        self.horizontalScrollBar.setMaximum(self.num_frames - 1)
        self.update_video(1)

    def update_video(self, frame=0):
        """Updates the video frame drawn to the canvas"""
        print('Updating video plot in a subWindow with:')
        print('***' + self.video_name + '[' + str(frame) + ']')
        # clear the Axes
        self.mpl.canvas.ax.clear()

        # show the image
        self.mpl.canvas.ax.imshow(self.video_file[frame-1], cmap='gray')
        print('imshow called')
        self.mpl.canvas.ax.axis('off')
        self.mpl.canvas.draw()


class DesignerSubWindowFolder(QWidget, Ui_WidgetFolderTree):
    """Customization for WidgetFolderTree subwindow for an MDI"""
    def __init__(self, parent=None, root=None):
        # initialization of the superclass
        super(DesignerSubWindowFolder, self).__init__(parent)
        self.dir = QDir(root)
        self.currentFileName = ''
        self.currentFilePath = ''
        # setup the GUI --> function generated by pyuic4
        self.setupUi(self)
        print('WidgetFolderTree UI setup')
        self.model = QFileSystemModel()
        self.model.setRootPath(root)
        self.treeView.setModel(self.model)
        self.treeView.setRootIndex(self.model.index(root))
        # self.pushButtonOpen.released.connect(self.open_tiff_from_folder)
        print('treeView ready')

    @QtCore.pyqtSlot(QtCore.QModelIndex)
    def on_treeView_clicked(self, index):
        index_item = self.model.index(index.row(), 0, index.parent())
        self.currentFileName = self.model.fileName(index_item)
        self.currentFilePath = self.model.filePath(index_item)
        print('Clicked: ' + self.currentFilePath + ' ' + self.currentFileName)

    def open_tiff_from_folder(self):
        # self.treeView.setTreePosition(2)
        print('Opening a tiff from a folder: ' + self.currentFileName)


# create the GUI application
app = QApplication(sys.argv)
# instantiate the main window
dmw = DesignerMainWindow()
# show it
dmw.show()
# start the Qt main loop execution, exiting from this script
# with the same return code as the Qt application
sys.exit(app.exec_())
